#!/usr/bin/gosh

(use file.util)

(define *spath* #f)
(define *path* #f)
(define *files* '("Makefile" "README" "example.scm" "sdl_helper.c"))

(define (get-new-makefile name str-list)
  (map
   (lambda (line)
     (regexp-replace #/example.scm/ line (string-append name ".scm")))
   str-list))



(define (change-file name)
  (call-with-input-file (string-append *spath* (list-ref *files* 0))
    (lambda (in)
      (let1 new-list (get-new-makefile name (port->string-list in))
            (close-input-port in)
            (call-with-output-file (string-append *path* (list-ref *files* 0))
              (lambda (out)
                (for-each (cut format out "~A\n" <>) new-list))))))
  (sys-rename (string-append *path* (list-ref *files* 2))
              (string-append *path* name ".scm"))
  )



(define (main args)  
  (make-directory* (cadr args))
  (set! *spath* (string-append (home-directory)
                               "/.c-wrapper/sdl/template/"))         
  (set! *path* (string-append (current-directory)
                              "/"
                              (cadr args)
                              "/"))    
  (for-each (lambda (x)                
              (copy-file (string-append *spath* x)
                         (string-append *path* x)                         
                         ))              
            *files*)
  (change-file (cadr args))
  )