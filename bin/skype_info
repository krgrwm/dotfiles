#! /usr/bin/env python2

import Skype4Py
import code
import sys
sys.path.append('/home/kegr/bin')
from skypeCmd import *

vs = {'skype':None, 'nowChat':None}
alias = {}

    
def norm(usrs, valid=['ONLINE']):
    f = usrs if 'ALL' in valid else filter(lambda x: x.OnlineStatus in valid, usrs)
    return sorted(f, key=lambda x:x.OnlineStatus)

# User Functions
def printUsers(usrs, valid=['ONLINE']):
    l = norm(usrs, valid)
    for u in l:
        print u.Handle

def printFriends(valid=['ONLINE']):
    printUsers(vs['skype'].Friends, valid)

def getFriendHandle(valid=['ONLINE']):
    printFriends(valid)
    fs = norm(vs['skype'].Friends, valid)
    i = int(raw_input('Friend: '))
    return fs[i].Handle

    
def printChats(chats):
    for ch in chats:
        p(str(ch).split('=')[1].split(';')[0], c.ORANGE)

def printBkmChats():
    printChats(vs['skype'].BookmarkedChats)

def getRecentChat():
    rcs = vs['skype'].RecentChats
    for i,ch in enumerate(rcs):
        print '[' + cld(str(i), c.ORANGE, ca.Standard) + "] " + \
                str(ch).split('=')[1].split(';')[0][2:]
    i = int(raw_input('Chat: '))
    return rcs[i]

def printRecentChats():
    printChats(vs['skype'].RecentChats)
    
def printMsg(msg):
    tm = '[' + str(msg.Datetime) + ']'
    sender = cld(msg.FromDisplayName, c.BLUE, ca.Bold)
    body = cld(msg.Body, c.PURPLE, ca.Bold)
    print tm + sender + ": " + body
    
def printChatMessages(chat, line=10):
    p(chat.Name.split(';')[0], c.ORANGE)
    for msg in reversed(chat.Messages[0:line]):
        printMsg(msg)

def printRecentChat(i=0, line=10):
    printChatMessages(vs['skype'].RecentChats[i], line)
    
def getBkmGroup():
    grps = vs['skype'].BookmarkedChats
    for i,g in enumerate(grps):
        print '[' + cld(str(i), c.ORANGE, ca.Standard) + "] " + \
                str(g).split('=')[1].split(';')[0][2:]
    i = int(raw_input('Groupe: '))
    return vs['skype'].BookmarkedChats[i]
    
def printBkmGroup(line=10):
    printChatMessages(getBkmGroup(), line)
    
def setChat(chat):
    p('Enter: ' + chat.Name, c.GREEN, ca.Standard)
    vs['nowChat'] = chat
    
def setChatWith(usernames):
    setChat(vs['skype'].CreateChatWith(usernames))
    
def setChatWithFriend(valid=['ONLINE']):
    setChatWith(getFriendHandle(valid))
    
def enterRecentChat():
    setChat(vs['skype'].RecentChats[0])
    
def printNowChat():
    p(vs['nowChat'].Name, c.GREEN, ca.Standard)
    
def sendMsgAtNowChat(msg):
    vs['nowChat'].SendMessage(msg)
    
def showAlias():
    for k,v in alias.iteritems():
        print cld(k,c.BLUE, ca.Standard) + ": " + str(v).split(' ')[1]
    
def addAlias():
    alias['prf'] = printFriends
    alias['prcs'] = printRecentChats
    alias['prc'] = printRecentChat
    alias['prg'] = printBkmGroup
    alias['rc'] = enterRecentChat
    alias['pc'] = printNowChat
    alias['sa'] = showAlias
    alias['send'] = sendMsgAtNowChat
    alias['chat'] = setChatWithFriend
    alias['grc'] = getRecentChat
    
    for k,v in alias.iteritems():
        setattr(sys.modules[__name__], k, v)




def OnMessageStatus(Message, Status):
    if Status == 'RECEIVED' or Status == 'SENT':
        print cld('[' + str(Message.Datetime) + ']', c.RED, ca.Bold) + ' ' + cld(Message.FromDisplayName, c.BLUE, ca.Standard) + ": " + Message.Body
        res = skypeCmd(vs['skype'], Message)
        if res:
            Message.Chat.SendMessage(res)
        

    
def initSkype(handler):
    vs['skype'] = Skype4Py.Skype()
    vs['skype'].Attach()
    #print "Attached"
    vs['skype'].OnMessageStatus = handler

def main():
    initSkype(OnMessageStatus)
    printFriends()

if __name__ == "__main__":
    main()
